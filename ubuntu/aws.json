{

  "builders": [

    {

      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "region": "{{user `aws_region`}}",
      "vpc_id": "{{user `aws_vpcid`}}",
      "subnet_id": "{{user `aws_subnetid`}}",
      "source_ami": "{{user `base_ami`}}",
      "instance_type": "{{ user `instance_type` }}",
      "ssh_username": "{{user `aws_username`}}",
      "ami_name": "{{user `image_name`}}",
      "ami_groups": "all",
      "shutdown_behavior": "terminate",

      "ami_block_device_mappings": [
        {
          "device_name": "/dev/xvdb",
          "snapshot_id": "{{ user `snapshot_id` }}",
          "volume_type": "gp2",
          "delete_on_termination": false
        }
      ],

      "tags": {
        "Name": "{{ user `aws_vmname` }}",
        "packer": "true",
        "parent_ami": "{{user `base_ami`}}",
        "App": "robots",
        "Environment": "{{ user `environment`}}",
        "Department": "TAM",
        "Deployed_by": "rdgacarvalho"

      }

    },

    {
      "type": "amazon-ebsvolume",
      "name": "ebsvol",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "region": "{{user `aws_region`}}",
      "vpc_id": "{{user `aws_vpcid`}}",
      "subnet_id": "{{user `aws_subnetid`}}",
      "source_ami": "{{user `base_ami`}}",
      "instance_type": "{{ user `instance_type` }}",
      "ssh_username": "{{user `aws_username`}}",
      "shutdown_behavior": "terminate",

      "ebs_volumes" : [
        {
          "volume_type" : "gp2",
          "device_name" : "/dev/xvdb",
          "delete_on_termination" : false,
          "snapshot_id": "{{ user `snapshot_id` }}",

          "tags": {
            "Name": "{{ user `aws_vmname` }}",
            "packer": "true",
            "parent_ami": "{{user `base_ami`}}",
            "App": "robots",
            "Environment": "{{ user `environment`}}",
            "Department": "TAM",
            "Deployed_by": "rdgacarvalho"
      
          }
        }
      ]
    }
  
  ],

  "provisioners": [
    {
    "type": "shell",
    "inline": ["sudo apt-get update",
               "sudo apt-get install -y python-minimal cloud-guest-utils",
               "sudo apt-get clean"
              ]
    },

    {
      "type": "ansible",
      "playbook_file": "../../ansible/{{ user `playbook` }}/main.yml",
      "extra_arguments": [ "-t nginx" ]
    }

  
  ],

  "post-processors": [
    {
      "type": "manifest",
      "only": ["amazon-ebs","ebsvol"],
      "output": "{{ user `aws_vmname` }}.json",
      "strip_path": true
    }

  ],

  "variables": {
    "aws_region": "eu-west-1",
    "aws_vmname": "",
    "aws_username": "ubuntu",
    "aws_vpcid": "vpc-bed067d9",
    "aws_subnetid": "subnet-69b31b0e",
    "image_name": "ubuntu-{{timestamp}}",
    "instance_type": "t2.micro",
    "aws_app_tag": "webserver",
    "aws_sg": "sg-9dace1fa",
    "base_ami": "ami-bbc542c8",
    "environment": "",
    "playbook": ""
  }

}